<!DOCTYPE html>
<html>
    <head>
        <title>Visual Association</title>
        <script src="jspsych/dist/jspsych.js"></script>
        <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
        <script src="jspsych/dist/plugin-instructions.js"></script>
        <script src="jspsych/dist/plugin-external-html.js"></script>
        <script src="jspsych/dist/plugin-survey-multi-choice.js"></script>
        <script src="jspsych/dist/plugin-survey-text.js"></script>
        <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css">
    </head>
    <body></body>
    <script>
        var jsPsych = initJsPsych({
            override_safe_mode: true
        });
        var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
        var study_id = jsPsych.data.getURLVariable('STUDY_ID');
        var session_id = jsPsych.data.getURLVariable('SESSION_ID');

        jsPsych.data.addProperties({
            subject_id: subject_id,
            study_id: study_id,
            session_id: session_id
        });
        var timeline = [];

        function runHeadphoneCheck() {
            $(document).on('hcHeadphoneCheckEnd', function(event, data) {
                var headphoneCheckDidPass = data.didPass;
                var headphoneCheckData = data.data;
                var didPassMessage = headphoneCheckDidPass ? 'passed' : 'failed';
                if (headphoneCheckDidPass == false) {
                alert( 'You ' + didPassMessage + ' the headphone screening task (you got ' + headphoneCheckData.totalCorrect + '/' + headphoneCheckData.stimIDList.length + ' trials correct). Please put headphones or earbuds in, reload this page, and try again.' );
                } else {
                passedHeadphoneCheck();
                }
            });
        }
        timeline.push(runHeadphoneCheck);

        var check_consent = function(){
            if (document.getElementById('consent_checkbox').checked) {
                return true;
            }
            else {
                alerta("If you wish to participate, you must check the box next to the statement 'I agree to participate'");
                return false;
            }
            return false;
        };

        var consentForm = {
            type: jsPsychExternalHtml,
            url: "external_page.html",
            cont_btn: "start",
            check_fn: check_consent
        };
        timeline.push(consentForm);

        var instructions = {
            type: jsPsychInstructions,
            pages: [ 
                "In this study, you will choose which of two actions best describes a video.On each trial, you will watch a video in which two shapes will move. The video will repeat once. Then two phrases will be displayed.\nYour job is to choose between Bounce/Stream you think best matches the video. There is no correct or incorrect answer. Go with your gut!",
                "Also, sometimes you will hear sound during the videos, so it is important you keep your headphones on at normal volume during the study, and do not listen to anything else, like music.",
                "We will be looking at the concept of 'bounce' and 'stream'",
                "Bounce is when the two objects look like they hit each other like they bounce so to speak.  Below is an example of bounce:" +
                "<br>" + "<img src=media/bounce_example.png></img>",
                "Stream is when the two objects pass each other or phase each other.  Below is an example of stream:" + "<br>" + "<img src=media/stream_example.png></img>",
                "The whole study will only take about 8-10 minutes; please stay focused!",
                "If you are ready, one more next to press to start"
            ],
            show_clickable_nav: true
        }
        timeline.push(instructions);

        var questionary = {
            type: jsPsychSurveyMultiChoice,
            questions: [
                {
                    prompt: "1: Are you a native speaker of English? In other words:" + "<ul>" + "<li>You learned English fluently from birth</li>" + "<li>You are a fluent speaker of English</li>" + "</ul",
                    name: "english",
                    options: ["Yes", "No", "Not sure"],
                    required: true,
                    horizontal: true
                },
                {
                    prompt: "2: Are you a native speaker of any other language " + " <i>besides</i>" + " English? In other words:" + "<ul>" + "<li>You learned that language fluently from birth</li>" + "<li>You are a fluent speaker of that language</li>" + "</ul",
                    name: "other lang",
                    options: ["Yes", "No", "Not sure"],
                    required: true,
                    horizontal: true
                },
                {
                    prompt:"3: What language do you currently use most?:",
                    name: "what lang",
                    options: ["English", "Other"],
                    required: true,
                    horizontal: true
                }
            ],
        }
        timeline.push(questionary);

        var open_ended = {
            type: jsPsychSurveyText,
            questions: [
                {
                    prompt: "1. How did you decide which phrase best matched the video?",
                    name: decide,
                    rows:5,
                    placeholder: "When the video was... I chose the phrase that..."
                },
                {
                    prompt: "2. Sometimes a beep played during the videos, and sometimes it did not. How do you think the presence of these beeps affected what you saw happen in the videos? (Just guess, do your best!)",
                    name: beep,
                    rows: 5,
                    placeholder: "When the beep played... When the beep didn't play..."
                },
                {
                    prompt: "3. In each trial, there were two options that you had to choose from. How would you describe them? (Just guess, do your best!) ",
                    name: choices,
                    rows: 5,
                    placeholder: "One kind was... The other kind was..."
                }
            ]
        }
        timeline.push(open_ended);

        var final_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<p>You've finished the last task. Thanks for participating!</p>
                <p><a href="https://app.prolific.co/submissions/complete?cc=XXXXXXX">Click here to return to Prolific and complete the study</a>.</p>`,
            choices: "NO_KEYS"
        }
        timeline.push(final_trial);

        function submitData(outDir) {
            // get data string from response array
            var dataString = JSON.stringify(responses);
            // post response to server
            $.post("helper_files/logTrial.py", {
                subjectID: subjectID,
                dataString: dataString,
                outDir: outDir
            });
        }
        timeline.push(submitData('./data'))
        jsPsych.run(timeline);
    </script>
</html>