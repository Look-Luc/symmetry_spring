<!DOCTYPE html>
<html>
    <head>
        <title>Visual Association</title>
        <script src="jspsych/dist/jspsych.js"></script>
        <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
        <script src="jspsych/dist/plugin-html-button-response.js"></script>
        <script src="jspsych/dist/plugin-instructions.js"></script>
        <script src="jspsych/dist/plugin-external-html.js"></script>
        <script src="jspsych/dist/plugin-survey-multi-choice.js"></script>
        <script src="jspsych/dist/plugin-survey-text.js"></script>
        <script src="jspsych/dist/plugin-instructions.js"></script>
        <script src="jspsych/dist/plugin-audio-button-response.js"></script>
        <script src="jspsych/dist/plugin-canvas-keyboard-response.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="helper_files/mturkfunctions.js"></script>
        <script src="animation.js"></script>
        <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css">
    </head>
    <body></body>
    <canvas id="myCanvas" width="450" height="450"></canvas>
    <script>
        var ctxAudio;
        var osc;
        var gain;
        var AudioContext = window.AudioContext || window.webkitAudioContext || true;
        var freq = 440;
        var t_sound;
        var soundOn = false;
        var meet = false
        var soundRampDown = 20; // ms for sound ramp down
        var soundDuration = 100;

        function getSONAInfo() {
        let urlParams = new URLSearchParams(window.location.search);
        SONAID = urlParams.get("survey_code");
        if (SONAID == null) {
            SONAID = 'NO-SUBJ-ID';
        }
        return SONAID;
        }

        var subjectID = getSONAInfo();

        var jsPsych = initJsPsych({
            show_progress_bar: false,
            override_safe_mode: true
        });

        function prepSound() {
            osc = ctxAudio.createOscillator();
            osc.frequency.value = freq;
            gain = ctxAudio.createGain();
            osc.connect(gain);
            gain.connect(ctxAudio.destination);
        }
        function startSineTone() {
            osc.start(0);
        }


        function ClickedConsent() {
            startStudyTimestamp_unix = new Date().getTime(); // unix epoch timestamp (i.e. date/time)
            startStudyTime = currentTime(); // current time (in browser time)

            // audio context (must be created after a user interacts with the page)
            if (AudioContext) {
                ctxAudio = new AudioContext();
            } else {
                // Web Audio API is not supported
                // Alert the user
                alert("Sorry, but the Web Audio API is not supported by your browser. Please consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox.");
            }
        }

        function stopSineTone() {
            gain.gain.setValueAtTime(gain.gain.value, ctxAudio.currentTime);
            gain.gain.exponentialRampToValueAtTime(
                0.0000001, ctxAudio.currentTime + soundRampDown/1000
            );
            osc.stop(ctxAudio.currentTime + soundRampDown/1000);
        }

        var timeline = [];
        var c = document.getElementById("myCanvas");

        //Start of Experiment
        var check_consent = function(elem) {
            if (document.getElementById('consent_checkbox').checked) {
                return true;
            }
            else {
                alert("If you wish to participate, you must check the box next to the statement 'I agree to participate in this study.'");
                return false;
            }
            return false;
        };

        var consentForm = {
            type: jsPsychExternalHtml,
            url: "external_page.html",
            cont_btn: "start",
            check_fn: check_consent
        };
        timeline.push(consentForm);

        var instructions = {
            type: jsPsychInstructions,
            pages: [ 
                "In this study, you will choose bounce/stream that best describes a video.  On each trial, you will watch a video in which two shapes will move. The video will repeat once. Then two words (Bounce and Stream) will be displayed.\nYour job is to choose between Bounce/Stream that you think best matches the video. There is no correct or incorrect answer. Go with your gut!",
                "Also, sometimes you will hear sound during the videos, so it is important you keep your headphones on at normal volume during the study, and do not listen to anything else, like music.",
                "We will be looking at the concept of 'bounce' and 'stream'",
                "Bounce is when the two objects are moving towards each other and hit each other and bounce off.  Below is an example of bounce:" +
                "<br>" + "<img src=media/bounce_example.png></img>" + "</br>As you can see, the two spheres come towards each other and at a point they  bounce off each other.",
                "Stream is when the two objects pass or phase each other.  Below is an example of stream:" + 
                "<br>" + "<img src=media/stream_example.png></img></br>As you can see, the spheres did not collide but instead went through each other.",
                "The whole study will only take about 8-10 minutes; please stay focused!",
                "If you are ready, one more next to press to start!!"
            ],
            show_clickable_nav: true
        }

        var questionary = {
            type: jsPsychSurveyMultiChoice,
            questions: [
                {
                    prompt: "1: Are you a native speaker of English? In other words:" + "<ul>" + "<li>You learned English fluently from birth</li>" + "<li>You are a fluent speaker of English</li>" + "</ul",
                    name: "english",
                    options: ["Yes", "No", "Not sure"],
                    required: true,
                    horizontal: true
                },
                {
                    prompt: "2: Are you a native speaker of any other language " + " <i>besides</i>" + " English? In other words:" + "<ul>" + "<li>You learned that language fluently from birth</li>" + "<li>You are a fluent speaker of that language</li>" + "</ul",
                    name: "other lang",
                    options: ["Yes", "No", "Not sure"],
                    required: true,
                    horizontal: true
                },
                {
                    prompt:"3: What language do you currently use most?:",
                    name: "what lang",
                    options: ["English", "Other"],
                    required: true,
                    horizontal: true
                }
            ],
        }

        var open_ended = {
            type: jsPsychSurveyText,
            questions: [
                {
                    prompt: "1. How did you decide which phrase best matched the video?",
                    rows:5,
                    placeholder: "When the video was... I chose the phrase that..."
                },
                {
                    prompt: "2. Sometimes a beep played during the videos, and sometimes it did not. How do you think the presence of these beeps affected what you saw happen in the videos? (Just guess, do your best!)",
                    rows: 5,
                    placeholder: "When the beep played... When the beep didn't play..."
                },
                {
                    prompt: "3. In each trial, there were two options that you had to choose from. How would you describe them? (Just guess, do your best!) ",
                    rows: 5,
                    placeholder: "One kind was... The other kind was..."
                }
            ]
        }

        var final_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<p>You've finished the last task. Thanks for participating!</p>
                <p><a href="https://app.prolific.co/submissions/complete?cc=XXXXXXX">Click here to return to Prolific and complete the study</a>.</p>`,
            choices: "NO_KEYS"
        }
        //timeline.push(final_trial);

        function submitData(outDir) {
            // get data string from response array
            var dataString = JSON.stringify(jsPsych.data.get().filter({task: 'response'}));
            // post response to server
            $.post("helper_files/logTrial.py", {
                subjectID: subjectID,
                dataString: dataString,
                outDir: outDir
            });
        }

        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: 1000,
        }
        var beepCount = 0
        var trial_anim = {
            type: jsPsychCanvasKeyboardResponse,
            stimulus: function dummy_function(c) {
                var ctx = c.getContext("2d");
                var rect1 = {
                    x0:0,
                    x:0,
                    y:200,
                    width: 450/8,
                    height: 450/8,
                    directionX: 0.25,
                }
                var rect2 = {
                    x0:c.width-450/8,
                    x:c.width-450/8,
                    y:200,
                    width: 450/8,
                    height: 450/8,
                    directionX: -0.25
                }
                var rects = [rect1, rect2];

                var circ1 = {
                    x0:0,
                    x:0,
                    y:200,
                    width: 450/16,
                    sAngle: 0,
                    eAngle: 2*Math.PI,
                    directionX: 0.25
                }
                var circ2 = {
                    x0:c.width,
                    x:c.width,
                    y:200,
                    width: 450/16,
                    sAngle: 0,
                    eAngle: 2*Math.PI,
                    directionX: -0.25
                }
                circles = [circ1, circ2]

                var isCirc = [true, false]
                var isBeep = [true, false]
                var hasBeep = isBeep[Math.floor(Math.random()*isBeep.length)]

                function stopS(){
                    stopSineTone();
                    soundOn = false;
                    meet == false
                }

                var T0 = performance.now()
                var colors = ["blue", "red", "green", "black"]
                var color = colors[Math.floor(Math.random()*colors.length)];
                var playCirc = isCirc[Math.floor(Math.random()*isCirc.length)]
                // next try to *animate* a rectangle moving
                ClickedConsent()
                var count
                $(function(){
                    prepSound()
                    requestAnimationFrame(animate);
                    function animate(time){
                        if(playCirc == false){
                            for(var i=0;i<rects.length;i++){
                                rects[i].x = rects[i].x0 + rects[i].directionX * (performance.now()-T0);
                            }
                        }
                        else{
                            for(var i=0;i<circles.length;i++){
                                circles[i].x = circles[i].x0 + circles[i].directionX * (performance.now()-T0);
                            }
                        }
                        draw();
                        requestAnimationFrame(animate);
                        function draw(){
                            ctx.beginPath()
                            ctx.clearRect(0,0,c.width,c.height)
                            ctx.strokeRect(0,0, c.width, c.height)
                            //ctx.moveTo(50,50)
                            
                            if(playCirc == false){
                                ctx.fillStyle = color
                                for(var i = 0; i < rects.length; i++){
                                    var temp = rects[i]
                                    ctx.fillRect(temp.x, temp.y, temp.width, temp.height)
                                }
                                if(isBeep & beepCount <= 24){
                                    if(soundOn == false & rects[0].x >= (c.width-rects[0].width)/2 & rects[1].x <= (c.width-rects[1].width)/2 & count == undefined){
                                        count = 0;
                                        startSineTone()
                                        soundOn = true;
                                        meet = true
                                        console.log("beep")
                                    }
                                    if(soundOn & meet){
                                        setTimeout(function(){
                                            //do what you need here
                                            stopS()
                                        }, 100);
                                    }
                                    beepCount++
                                }
                                console.log(beepCount)
                                //ctx.stroke()
                            }
                            else{
                                for(var i = 0; i < circles.length; i++){
                                    var temp = circles[i]
                                    ctx.fillStyle = color
                                    ctx.lineWidth = 1;
                                    ctx.strokeStyle = colors
                                    ctx.moveTo(temp.x+temp.width, temp.y)
                                    ctx.arc(temp.x, temp.y, temp.width, temp.sAngle, temp.eAngle)
                                    ctx.fill()
                                }
                                if(isBeep & beepCount <= 24){
                                    if(soundOn == false & circles[0].x >= (c.width-circles[0].width)/2 & circles[1].x <= (c.width-circles[1].width)/2 & count == undefined){
                                        count = 0;
                                        startSineTone()
                                        soundOn = true;
                                        meet = true
                                        console.log("beep")
                                    }
                                    if(soundOn & meet){
                                        setTimeout(function(){
                                            //do what you need here
                                            stopS()
                                        }, 100);
                                    }
                                    beepCount++
                                }
                                //ctx.stroke()
                            }
                        }
                    }
                })
            },
            prompt: "<p>Bounce (F) or Stream (J)</p>",
            choices: ['f', 'j'],
            data:{
                task: 'response'
            }
        }

        var test_procedure = {
            timeline: [fixation, trial_anim, fixation, trial_anim],
            repetitions: 24,
        };

        //----------------------------------------------------------------------------------//
        // HEADPHONE CHECK STIMULI WITH METADATA
        //----------------------------------------------------------------------------------//
        var headphone_stimuli = [
            {stimulus: 'headphoneCheck/assets/antiphase_HC_IOS.wav', correct_response: '2'},
            {stimulus: 'headphoneCheck/assets/antiphase_HC_ISO.wav', correct_response: '1'},
            {stimulus: 'headphoneCheck/assets/antiphase_HC_OIS.wav', correct_response: '2'},
            {stimulus: 'headphoneCheck/assets/antiphase_HC_OSI.wav', correct_response: '1'},
            {stimulus: 'headphoneCheck/assets/antiphase_HC_SIO.wav', correct_response: '0'},
            {stimulus: 'headphoneCheck/assets/antiphase_HC_SOI.wav', correct_response: '0'}
        ];

        //----------------------------------------------------------------------------------//
        // HEADPHONE CHECK TRIAL
        // Adapted from https://github.com/mcdermottLab/HeadphoneCheck
        //----------------------------------------------------------------------------------//
       
        var do_hc = true;
        var correct_trials = 0;
        
        var headphone_check = {
            type: jsPsychAudioButtonResponse,
            stimulus: jsPsych.timelineVariable('stimulus'),
            prompt: 'Which of the three sounds was the quietest?',
            choices: ['1st','2nd','3rd'],
            response_ends_trial: true,
            post_trial_gap: 1000,
            data: {correct_response: jsPsych.timelineVariable('correct_response')},
            on_finish: function(data){
                data.correct = (data.response == data.correct_response);
            }
        };

        var headphone_check_pass = {
            type: jsPsychInstructions,
            show_clickable_nav: true,
            pages: [
                //P1
                '<p>You passed the headphone check!</p>' +
                '<p>Click <strong>Next</strong> to continue.</p>',
                ],
        };

        //----------------------------------------------------------------------------------//
        // OPTIONS IF HEADPHONE CHECK FAILED A SECOND TIME
        //----------------------------------------------------------------------------------//
        
        // create variable to determine which node plays next:
        //  0 = redo headphone check
        //  1 = continue to experiment as if they had passed check; data will be marked as unusable
        //  2 = continue to debrief to get SONA credit
        var fail_choice;
        
        var fail_options = {
            type: jsPsychHtmlButtonResponse,
            stimulus: 'Options:',
            prompt: 'You have now failed the headphone check twice. You may either retry the headphone check; continue to the experiment, but know that your data will not be used by the experimenters (you will still get SONA credit); or be redirected to SONA where you will get full credit for attempting the experiment.',
            choices: ['Try headphone check again', 'Continue to experiment', 'Redirect to SONA'],
            on_start: function() {
                fail_choice = null;
            },
            on_finish: function(trial_data) {
                var response = trial_data.response
                if (response == 0) {
                    do_hc = true;
                    fail_choice = 0;
                } else if (response == 1) {
                    //timeline
                    fail_choice = 1;
                } else if (response == 2) {
                    fail_choice = 2;
                }
            }
        };
        //timeline.push(fail_options);

        var fail_options_node = {
            timeline: [fail_options],
            conditional_function: function() {
                correct_trials = jsPsych.data.get().last(6).filter({
                    correct: true,
                    trial_type: jsPsychAudioButtonResponse
                }).count();
                return (correct_trials < 5);
            }
        };

        //----------------------------------------------------------------------------------//
        // HEADPHONE CHECK BLOCK
        //----------------------------------------------------------------------------------//

        var headphone_check_node = {
            timeline: [headphone_check],
            timeline_variables: headphone_stimuli,
            randomize_order: true,
            repetitions: 1,
            conditional_function: function() {
                return (do_hc);
            }
        };
        //timeline.push(headphone_check_node)

        var headphone_check_loop = {
            timeline: [headphone_check_node, fail_options_node],
            loop_function: function() {
                 correct_trials = jsPsych.data.get().last(6).filter({
                 correct: true,
                 trial_type: jsPsychAudioButtonResponse
                }).count();
                return (correct_trials < 5);
            },
            conditional_function: function() {
                return (fail_choice == 0)
            }

        }
        timeline.push(headphone_check_loop);

        //----------------------------------------------------------------------------------//
        // HEADPHONE CHECK PROCEEDINGS **IF PASSED**
        //----------------------------------------------------------------------------------//
        var hc_pass = {
            timeline: [
                //consentForm,
                headphone_check_pass, 
                instructions,
                test_procedure,
                questionary,
                open_ended,
                final_trial
                ],
            conditional_function: function() {
                correct_trials = jsPsych.data.get().last(6).filter({
                correct: true,
                trial_type: "audio-button-response"
            }).count();
                return (correct_trials >= 5);
            }
        };
        timeline.push(hc_pass);

        var hc_pass_failed_hc = {
            timeline: [ 
                //instructions, 
                //consentForm,
                instructions,
                test_procedure,
                questionary,
                open_ended,
                final_trial,
                submitData('./helper_files/data')
            ],
            conditional_function: function() {
                return (fail_choice == 1);
            }
        };
        timeline.push(hc_pass_failed_hc);

        //----------------------------------------------------------------------------------//
        // HEADPHONE CHECK PROCEEDINGS **IF DID NOT PASS**
        //----------------------------------------------------------------------------------//
        
        var hc_round_2 = {
            timeline: [headphone_check],
            timeline_variables: headphone_stimuli,
            randomize_order: true,
            repetitions: 1
        };
        timeline.push(hc_round_2);

        var headphone_check_fail = {
            type: jsPsychInstructions,
            show_clickable_nav: true,
            pages: [
                '<p>You have failed the headphone check, getting ' + correct_trials + ' out of 6 trials correct. You need at least 5 correct to pass.</p>' +
                '<p>You will now repeat the headphone check. Make sure you are in a quiet location with headphones on. Click <strong>"Next"</strong> to continue.</p>'
            ],
            on_start: function() {
                correct_trials = jsPsych.data.get().last(6).filter({
                    correct: true,
                    trial_type: jsPsychAudioButtonResponse
                }).count();
            },
            on_finish: function() {
                console.log(correct_trials);
            }
        };
        
        var hc_fail = {
            timeline: [
                //consentForm,
                headphone_check_fail,
                hc_round_2,
                hc_pass,
                fail_options_node,
                headphone_check_loop,
                hc_pass_failed_hc,
                instructions,
                test_procedure,
                questionary,
                open_ended,
                final_trial,
                submitData('./data')
            ],
            on_start: function() {
                do_hc = false;
            },
            conditional_function: function() {
                correct_trials = jsPsych.data.get().last(6).filter({
                correct: true,
                trial_type: jsPsychAudioButtonResponse
            }).count();
                return (correct_trials < 5);
            }
        };
        timeline.push(hc_fail);

        jsPsych.run(timeline);
        console.log(jsPsych.data.get().filter({task: 'response'}))
    </script>
</html>